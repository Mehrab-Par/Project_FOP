#include "UIManager.h"
#include <cstring>
#include "Logger.h"

// ─── 5x7 pixel font (printable ASCII 32-126)
static const unsigned char FONT5x7[95][7] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // space
{0x04,0x04,0x04,0x04,0x00,0x04,0x00}, // !
{0x0A,0x0A,0x00,0x00,0x00,0x00,0x00}, // "
{0x0A,0x1F,0x0A,0x0A,0x1F,0x0A,0x00}, // #
{0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04}, // $
{0x18,0x19,0x02,0x04,0x08,0x13,0x03}, // %
{0x0C,0x12,0x14,0x08,0x15,0x12,0x0D}, // &
{0x04,0x04,0x00,0x00,0x00,0x00,0x00}, // '
{0x02,0x04,0x08,0x08,0x08,0x04,0x02}, // (
{0x08,0x04,0x02,0x02,0x02,0x04,0x08}, // )
{0x00,0x04,0x15,0x0E,0x15,0x04,0x00}, // *
{0x00,0x04,0x04,0x1F,0x04,0x04,0x00}, // +
{0x00,0x00,0x00,0x00,0x04,0x04,0x08}, // ,
{0x00,0x00,0x00,0x1F,0x00,0x00,0x00}, // -
{0x00,0x00,0x00,0x00,0x00,0x04,0x00}, // .
{0x01,0x01,0x02,0x04,0x08,0x10,0x10}, // /
{0x0E,0x11,0x13,0x15,0x19,0x11,0x0E}, // 0
{0x04,0x0C,0x04,0x04,0x04,0x04,0x0E}, // 1
{0x0E,0x11,0x01,0x06,0x08,0x10,0x1F}, // 2
{0x1F,0x01,0x02,0x06,0x01,0x11,0x0E}, // 3
{0x02,0x06,0x0A,0x12,0x1F,0x02,0x02}, // 4
{0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E}, // 5
{0x06,0x08,0x10,0x1E,0x11,0x11,0x0E}, // 6
{0x1F,0x01,0x02,0x04,0x08,0x08,0x08}, // 7
{0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E}, // 8
{0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C}, // 9
{0x00,0x04,0x00,0x00,0x04,0x00,0x00}, // :
{0x00,0x04,0x00,0x00,0x04,0x04,0x08}, // ;
{0x02,0x04,0x08,0x10,0x08,0x04,0x02}, // <
{0x00,0x00,0x1F,0x00,0x1F,0x00,0x00}, // =
{0x08,0x04,0x02,0x01,0x02,0x04,0x08}, // >
{0x0E,0x11,0x01,0x02,0x04,0x00,0x04}, // ?
{0x0E,0x11,0x17,0x15,0x17,0x10,0x0E}, // @
{0x0E,0x11,0x11,0x1F,0x11,0x11,0x11}, // A
{0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E}, // B
{0x0E,0x11,0x10,0x10,0x10,0x11,0x0E}, // C
{0x1C,0x12,0x11,0x11,0x11,0x12,0x1C}, // D
{0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F}, // E
{0x1F,0x10,0x10,0x1E,0x10,0x10,0x10}, // F
{0x0E,0x11,0x10,0x17,0x11,0x11,0x0F}, // G
{0x11,0x11,0x11,0x1F,0x11,0x11,0x11}, // H
{0x0E,0x04,0x04,0x04,0x04,0x04,0x0E}, // I
{0x07,0x02,0x02,0x02,0x02,0x12,0x0C}, // J
{0x11,0x12,0x14,0x18,0x14,0x12,0x11}, // K
{0x10,0x10,0x10,0x10,0x10,0x10,0x1F}, // L
{0x11,0x1B,0x15,0x15,0x11,0x11,0x11}, // M
{0x11,0x19,0x15,0x13,0x11,0x11,0x11}, // N
{0x0E,0x11,0x11,0x11,0x11,0x11,0x0E}, // O
{0x1E,0x11,0x11,0x1E,0x10,0x10,0x10}, // P
{0x0E,0x11,0x11,0x11,0x15,0x12,0x0D}, // Q
{0x1E,0x11,0x11,0x1E,0x14,0x12,0x11}, // R
{0x0F,0x10,0x10,0x0E,0x01,0x01,0x1E}, // S
{0x1F,0x04,0x04,0x04,0x04,0x04,0x04}, // T
{0x11,0x11,0x11,0x11,0x11,0x11,0x0E}, // U
{0x11,0x11,0x11,0x11,0x11,0x0A,0x04}, // V
{0x11,0x11,0x15,0x15,0x15,0x15,0x0A}, // W
{0x11,0x11,0x0A,0x04,0x0A,0x11,0x11}, // X
{0x11,0x11,0x0A,0x04,0x04,0x04,0x04}, // Y
{0x1F,0x01,0x02,0x04,0x08,0x10,0x1F}, // Z
{0x0E,0x08,0x08,0x08,0x08,0x08,0x0E}, // [
{0x10,0x10,0x08,0x04,0x02,0x01,0x01}, // backslash
{0x0E,0x02,0x02,0x02,0x02,0x02,0x0E}, // ]
{0x04,0x0A,0x11,0x00,0x00,0x00,0x00}, // ^
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F}, // _
{0x08,0x04,0x00,0x00,0x00,0x00,0x00}, // `
{0x00,0x00,0x0E,0x01,0x0F,0x11,0x0F}, // a
{0x10,0x10,0x1E,0x11,0x11,0x11,0x1E}, // b
{0x00,0x00,0x0E,0x10,0x10,0x10,0x0E}, // c
{0x01,0x01,0x0F,0x11,0x11,0x11,0x0F}, // d
{0x00,0x00,0x0E,0x11,0x1F,0x10,0x0E}, // e
{0x06,0x09,0x08,0x1C,0x08,0x08,0x08}, // f
{0x00,0x00,0x0F,0x11,0x0F,0x01,0x0E}, // g
{0x10,0x10,0x16,0x19,0x11,0x11,0x11}, // h
{0x04,0x00,0x0C,0x04,0x04,0x04,0x0E}, // i
{0x02,0x00,0x06,0x02,0x02,0x12,0x0C}, // j
{0x10,0x10,0x12,0x14,0x18,0x14,0x12}, // k
{0x0C,0x04,0x04,0x04,0x04,0x04,0x0E}, // l
{0x00,0x00,0x1A,0x15,0x15,0x11,0x11}, // m
{0x00,0x00,0x16,0x19,0x11,0x11,0x11}, // n
{0x00,0x00,0x0E,0x11,0x11,0x11,0x0E}, // o
{0x00,0x00,0x1E,0x11,0x1E,0x10,0x10}, // p
{0x00,0x00,0x0F,0x11,0x0F,0x01,0x01}, // q
{0x00,0x00,0x16,0x19,0x10,0x10,0x10}, // r
{0x00,0x00,0x0E,0x10,0x0E,0x01,0x1E}, // s
{0x08,0x08,0x1C,0x08,0x08,0x09,0x06}, // t
{0x00,0x00,0x11,0x11,0x11,0x13,0x0D}, // u
{0x00,0x00,0x11,0x11,0x11,0x0A,0x04}, // v
{0x00,0x00,0x11,0x15,0x15,0x15,0x0A}, // w
{0x00,0x00,0x11,0x0A,0x04,0x0A,0x11}, // x
{0x00,0x00,0x11,0x11,0x0F,0x01,0x0E}, // y
{0x00,0x00,0x1F,0x02,0x04,0x08,0x1F}, // z
{0x06,0x08,0x08,0x18,0x08,0x08,0x06}, // {
{0x04,0x04,0x04,0x00,0x04,0x04,0x04}, // |
{0x0C,0x02,0x02,0x03,0x02,0x02,0x0C}, // }
{0x08,0x15,0x02,0x00,0x00,0x00,0x00}, // ~
};

void UIManager::drawChar(SDL_Renderer* r, char c, int x, int y, SDL_Color col, int s) {
    int idx = (unsigned char)c - 32;
    if (idx < 0 || idx >= 95) return;
    SDL_SetRenderDrawColor(r, col.r, col.g, col.b, col.a);
    for (int row = 0; row < 7; row++) {
        unsigned char bits = FONT5x7[idx][row];
        for (int col2 = 0; col2 < 5; col2++) {
            if (bits & (0x10 >> col2)) {
                SDL_Rect px = {x + col2*s, y + row*s, s, s};
                SDL_RenderFillRect(r, &px);
            }
        }
    }
}

void UIManager::drawText(SDL_Renderer* r, const std::string& txt,
                         int x, int y, SDL_Color col, int s) {
    int cx = x;
    for (char c : txt) {
        if (c == ' ') { cx += 4*s; continue; }
        drawChar(r, c, cx, y, col, s);
        cx += 6*s;
    }
}

// ─── lifecycle ───────────────────────────────────────────────────────────────

UIManager::UIManager()
    : W(1280), H(720), spriteCount(1), selectedIdx(0),
      lastSelectedSpriteIndex(0),
      showLog(true),
      palScrollY(0), palContentHeight(2000), selectedCatTab(0),
      showSaveDialog(false), saveConfrimed(false) {}
UIManager::~UIManager() {}

void UIManager::init(int w, int h) {
    W = w; H = h;
    int contH = H - UILayout::MENU_H - UILayout::SPR_H;
    int edW   = W - UILayout::PAL_W - UILayout::STAGE_W - 8;

    menuBar.rect  = {0,0,W,UILayout::MENU_H};
    menuBar.bgColor = {55,55,55,255};

    palPanel.rect  = {0,UILayout::MENU_H,UILayout::PAL_W,contH};
    palPanel.bgColor = {245,245,245,255};

    edPanel.rect   = {UILayout::PAL_W,UILayout::MENU_H,edW,contH};
    edPanel.bgColor = {255,255,255,255};

    int sx = UILayout::PAL_W + edW + 8;
    stagePanel.rect   = {sx, UILayout::MENU_H+5, UILayout::STAGE_W, UILayout::STAGE_H};
    stagePanel.bgColor= {255,255,255,255};

    sprBar.rect   = {0,H-UILayout::SPR_H,W,UILayout::SPR_H};
    sprBar.bgColor= {235,235,235,255};

    logPanel.rect = {sx, UILayout::MENU_H+5+UILayout::STAGE_H+6,
                     UILayout::LOG_W, UILayout::LOG_H};
    logPanel.bgColor={25,25,25,255};
    logPanel.visible = true;

    buildButtons();
    addLog("Ready! Drag blocks to editor.", "INFO");
}

void UIManager::buildButtons() {
    menuBtns.clear(); sprBtns.clear();

    auto mb = [](int id, const char* lbl, int x, int y, int w, int h,
                 SDL_Color c, SDL_Color hc) {
        Button b; b.id=id; b.label=lbl; b.rect={x,y,w,h};
        b.color=c; b.hoverColor=hc; return b;
    };

    int y=5, bh=24;
    // Left group
    menuBtns.push_back(mb(BTN_NEW_PROJECT,"New",   6, y,52,bh,{70,120,170,255},{90,140,190,255}));
    menuBtns.push_back(mb(BTN_SAVE,      "Save",  62, y,52,bh,{40,110,40,255}, {60,140,60,255}));
    menuBtns.push_back(mb(BTN_LOAD,      "Load", 118, y,52,bh,{130,90,30,255},{155,110,50,255}));

    // Right group
    int rx = W-320;
    menuBtns.push_back(mb(BTN_RUN,  "Run",   rx,   y,70,bh,{34,177,76,255},{50,200,90,255}));
    menuBtns.push_back(mb(BTN_PAUSE,"Pause", rx+74,y,70,bh,{200,160,0,255},{220,180,20,255}));
    menuBtns.push_back(mb(BTN_STOP, "Stop",  rx+148,y,70,bh,{190,40,40,255},{215,60,60,255}));
    menuBtns.push_back(mb(BTN_TOGGLE_LOG,"Log",W-62,y,54,bh,{60,60,60,255},{85,85,85,255}));

    // Sprite bar
    Button ab; ab.id=BTN_ADD_SPRITE; ab.label="+Add";
    ab.rect={8,sprBar.rect.y+10,58,28};
    ab.color={60,120,170,255}; ab.hoverColor={80,140,190,255};
    sprBtns.push_back(ab);
}